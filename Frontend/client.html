<html>
  <head>
    <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.24.0/babel.js"></script>
  </head>
  <body>
    <div id="root"></div> 

    <script type="text/babel">
      const ProductRow = ({ product }) => (
        <tr>
          <td style={{ color: product.stocked > 0 ? 'black' : 'red' }}>
            &nbsp;&nbsp;&gt;&nbsp;{product.name}</td>
          <td>${product.price.toFixed(2)}</td>
        </tr>
      )

      const ProductCategoryRow = ({ category }) => (
        <tr>
          <td style={{ fontWeight: 'bold' }} colSpan="2">{category}</td>
        </tr>
      )

      const ProductTable = ({ inStockOnly, filterText, products }) => {
        let lastCategory = ''
        return (
          <table>
            <tbody>
              {products.filter((product) => (
                (inStockOnly ? product.stocked > 0 : true) &&
                (product.name.startsWith(filterText))
              )).map((product) => {
                if (lastCategory !== product.category) {
                  lastCategory = product.category
                  return (
                    <React.Fragment key={product.category}>
                      <ProductCategoryRow category={product.category} />
                      <ProductRow key={product.id} product={product} />
                    </React.Fragment>
                  )
                }
                return <ProductRow key={product.id} product={product} />
              })}
            </tbody>
          </table>
        )
      }

      const SearchBar = ({ inStockOnly, filterText, toggleCheckbox, inputText }) => (
        <form>
          <input type="text" value={filterText} onChange={(event) => inputText(event.target.value)} /> <br />
          <label><input type="checkbox" checked={inStockOnly} onChange={toggleCheckbox} /> Only show in stock</label>
        </form>
      )

      const FilterableProductTable = () => {
        const [ productsData, setProductsData ] = React.useState({
          loading: true,
          data: [],
          errors: ''
        })
        const [ filterText, setFilterText ] = React.useState('')
        const [ inStockOnly, setInStockOnly ] = React.useState(false)

        React.useEffect(() => {
          fetch("http://127.0.0.1:8000/products")
            .then(response => response.json())
            .then(result => setProductsData({
                loading: false,
                data: result,
                error: '',
              })
            )
            .catch(error => setProductsData({
                loading: false,
                data: [],
                errors: error,
              })
            );
        }, [])

        const toggleCheckbox = () => {
          setInStockOnly((oldValue) => !oldValue)
        }

        const inputText = (text) => {
          setFilterText(text)
        }

        if (productsData.loading) {
          return (
            <div>
              Loading...
            </div>
          )
        }

        if (productsData.error) {
          return (
            <div>
              Error: {error}
            </div>
          )
        }

        return (
          <div>
            <SearchBar
              inStockOnly={inStockOnly}
              filterText={filterText}
              toggleCheckbox={toggleCheckbox}
              inputText={inputText}
            />
            <ProductTable
              inStockOnly={inStockOnly}
              filterText={filterText}
              products={productsData.data}
            />
          </div>
        )
      }

     ReactDOM.render(
         <FilterableProductTable />,
         document.getElementById('root')
     )

    </script>
  </body>
</html>